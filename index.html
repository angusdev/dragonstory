<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Dragon Story</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="jquery.xdomainajax.ellab-1.0.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
<script src="dragonstory.js"></script>
<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
<style>
.container {
  width: 100%;
}
iframe {
  width: 100%;
  border: none;
  overflow: hidden;
}
.flyover {
   left: 150%;
   overflow: hidden;
   position: fixed;
   width: 50%;
   opacity: 0.9;
   z-index: 1050;
   transition: left 0.6s ease-out 0s;
   -webkit-transition: left 0.6s ease-out 0s;
}
.flyover-centered {
   top: 50%;
   transform: translate(-50%, -50%);
   -webkit-transform: translate(-50%, -50%);
}
.flyover.in {
   left: 50%;
}

.dropdown-submenu{position:relative;}
.dropdown-submenu>.dropdown-menu{top:0;left:100%;margin-top:-6px;margin-left:-1px;-webkit-border-radius:0 6px 6px 6px;-moz-border-radius:0 6px 6px 6px;border-radius:0 6px 6px 6px;}
.dropdown-submenu:hover>.dropdown-menu{display:block;}
.dropdown-submenu>a:after{display:block;content:" ";float:right;width:0;height:0;border-color:transparent;border-style:solid;border-width:5px 0 5px 5px;border-left-color:#cccccc;margin-top:5px;margin-right:-10px;}
.dropdown-submenu:hover>a:after{border-left-color:#ffffff;}
.dropdown-submenu.pull-left{float:none;}.dropdown-submenu.pull-left>.dropdown-menu{left:-100%;margin-left:10px;-webkit-border-radius:6px 0 6px 6px;-moz-border-radius:6px 0 6px 6px;border-radius:6px 0 6px 6px;}
</style>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
  <div class="navbar-header">
    <span class="navbar-brand">Dragon Story</span>
  </div>

  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse navbar-right">
    <div class="navbar-form">
      <button type="submit" class="btn btn-default" data-role="reload">Reload</button>
    </div>
  </div>
  <div class="collapse navbar-collapse navbar-right">
    <ul class="nav navbar-nav">
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id='dragon-count'>Loading...</span> <b class="caret"></b></a>
      <ul class="dropdown-menu" id="dragon-count-dropdown">
        <li><a href="#">Loading...</a></li>
      </ul>
    </li>
  </div>
  <div class="collapse navbar-collapse navbar-right">
    <div class="navbar-form">
      <div class="form-group">
        <input type="text" class="form-control" placeholder="Search">
      </div>
    </form>
  </div><!-- /.navbar-collapse -->
</nav>

<div id="new-dragon-notice" class="jumbotron flyover flyover-centered">
   <h2>New Dragon !!!</h2>
   <p>
      This is the text to show in the message.
   </p>
   <button class="btn btn-primary" data-role="close">Dismiss</button>
</div>

<div class="container">
  <ul class="nav nav-tabs" id="tabs">
    <li class="active"><a href="#breedtab" data-toggle="tab">Breeding</a></li>
    <li><a href="#parenttab" data-toggle="tab">Parents</a></li>
    <li><a href="#battletab" data-toggle="tab">Battle Arena</a></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane active" id="breedtab">
      <iframe src="breed.html"></iframe>
    </div>
    <div class="tab-pane" id="parenttab">
      <iframe src="parent.html"></iframe>
    </div>
    <div class="tab-pane" id="battletab">
      <iframe src="battle.html"></iframe>
    </div>
  </div>

  <div class="well">
    <div class="row">
      <div class="col-sm-6 col-md-6">
        Twitter <a href="http://twitter.com/angusdev">@angusdev</a>
      </div>
      <div class="col-sm-6 col-md-6" style="text-align:right;">
        Data Source: <a href="http://dragon-story.wikia.com/">http://dragon-story.wikia.com/</a>
      </div>
    </div>
  </div>
</div>

<select id="select_opponent" style="display:none;"></select>
<select id="select_opponent_level" style="display:none;"></select>
<div style="display:none;"><div id="form_opponent"></div></div>
<div id="content_scores" style="display:none;"></div>
</body>
<script>
function loadData(reload) {
  var ds = org.ellab.dragonstory;

  $('#dragon-count').html('Loading...');

  $('.tab-content iframe').each(function(){
    this.contentWindow.$('body').trigger('ellabBreedDataBeforeLoad');
    this.contentWindow.$('body').trigger('ellabBattleDataBeforeLoad');
  });

  if (reload) {
    ds.clearStoredBreedData();
    ds.clearStoredBattleData();
  }

  $.when(ds.loadBreedData(), ds.loadBattleData()).done(function(breed, battle) {
    var oldbreeds = (typeof breeds !== 'undefined')?breeds:null;
    var addedDragonHTML = '';

    // I know, I know this is dangerous
    eval(breed);

    $('#dragon-count-dropdown').empty();

    var typeCount = {};
    var typeArray = [];

    for (type in type_image_url) {
      typeArray.push(type);
      typeCount[type] = { count: 0, dragons: [] };
    }
    typeArray.sort();

    if (breeds && type_image_url) {
      for (dragonid in breeds) {
        // build the type count
        (breeds[dragonid].types || []).forEach(function(type) {
          typeCount[type].count++;
          typeCount[type].dragons.push({dragonid: dragonid, dragon: breeds[dragonid]});
        });

        // compare the added dragons
        if (oldbreeds && typeof oldbreeds[dragonid] === 'undefined') {
          addedDragonHTML += '<div class="row"><div class="col-md-4">' + ds.capitalize(dragonid) + '</div><div class="col-md-8">';
          (breeds[dragonid].types || []).forEach(function(type) {
            addedDragonHTML += '<img src="' + type_image_url[type] + '"/> ';
          });
          addedDragonHTML += '</div></div>';
        }
      }

      // build the dragon dropdown menu
      typeArray.forEach(function(type) {
        var dropdownHTML = '<li class="dropdown-submenu"><a href="#"><img src="' + type_image_url[type] + '" width="16" /> '  +
          ds.capitalize(type) +
          ' (' + typeCount[type].count + ')</a><ul class="dropdown-menu">';

        typeCount[type].dragons.forEach(function(dragon) {
          dropdownHTML += '<li><a href="#" data-dragon="' + dragon.dragonid + '">' +
                          dragon.dragon.name +
                          ' <img width="16" src="' + type_image_url[type] + '"/> ';
          (dragon.dragon.types || []).forEach(function(othertype) {
            if (type !== othertype) {
              dropdownHTML += ' <img width="16" src="' + type_image_url[othertype] + '"/> ';
            }
          });
          dropdownHTML += '</a></li>';
        });

        dropdownHTML += '</ul></li>';

        $('#dragon-count-dropdown').append(dropdownHTML);
      });
    }

    $('#dragon-count').html(typeArray.length + ' Types, ' + Object.keys(breeds).length + ' Dragons');
    if (addedDragonHTML) {
      $('#new-dragon-notice').addClass('in').find('> p').html(addedDragonHTML);
    }

    //breeds = null;
    //type_image_url = null;

    $('.tab-content iframe').each(function(){
      this.contentWindow.$('body')
        .trigger('ellabBreedDataChanged', [ breed ] )
        .trigger('ellabBattleDataChanged', [ battle ] );
    });
  });
}

var breedReady = false;
var parentReady = false;
var battleReady = false;

$(document).ready(function() {
  if (document.location.protocol === 'file:') {
    $('.tab-content iframe').height(1000);
  }
  else {
    window.setInterval(function() {
      $('.tab-content iframe').each(function() {
        var h = $(this).contents().find(".container").height();
        $(this).height(h);
      });
    }, 100);
  }

  $('[data-role="reload"]').click(function(e) {
    loadData(true);
  });

  $(document).on('click', '.jumbotron [data-role="close"]', function() {
    $(this).closest('.jumbotron').removeClass('in');
  });

  $(document.body).bind('ellabPageReady', function(e, page) {
    console.log('ellabPageReady ' + page);

    if (page === 'breed') {
      breedReady = true;
    }
    else if (page === 'parent') {
      parentReady = true;
    }
    else if (page === 'battle') {
      battleReady = true;
    }

    if (breedReady && parentReady && battleReady) {
      loadData();
    }
  });

});
</script>
</html>
