<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Dragon Story</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="jquery.xdomainajax.ellab-1.0.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
<script src="//cdn.jsdelivr.net/typeahead.js/0.9.3/typeahead.min.js"></script>
<script src="//cdn.jsdelivr.net/hogan.js/2.0.0/hogan.common.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.13.3/jquery.tablesorter.min.js"></script>
<script src="dragonstory.js"></script>
<link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
<link rel="stylesheet" href="bootstrap-more.css">
<lin1k rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.13.3/css/theme.blue.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.13.3/css/theme.bootstrap.css">
<style>
.container {
  width: 100%;
}
iframe {
  width: 100%;
  border: none;
  overflow: hidden;
}

/* make it invisible */
iframe[data-role=libiframe] {
 position:absolute;
 left:-1000px;
 width:1px;
 height:1px;
}

.navbar .twitter-typeahead .tt-dropdown-menu {
  width: 360px;
}

.navbar .dragon-name {
  color: rgb(153, 51, 1);
  font-weight: bold;
}

.navbar .tt-is-under-cursor .dragon-name, .navbar .tt-is-under-cursor .dragon-rarity {
  color: white;
}

.navbar .glyphicon {
  margin-right:10px;
}

#mydragoncontainer .tablesorter th:nth-child(n+5) .tablesorter-header-inner {
  text-align: center;
  padding: 4px;
}

#mydragoncontainer .tablesorter td:nth-child(n+5) {
  text-align: center;
  color: #aaa;
}

#mydragoncontainer .tablesorter [data-level="0"].selected {
  background-color: #aaa;
}

#mydragoncontainer .tablesorter .selected {
  background-color: #cfb;
}

#input-mydragon textarea {
  width: 100%;
}
</style>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
  <div class="navbar-header">
    <span class="navbar-brand">Dragon Story</span>
  </div>

  <div class="collapse navbar-collapse navbar-right">
    <ul class="nav navbar-nav">
      <!-- Dragon Dropdown -->
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id='dragon-count'>Loading...</span> <b class="caret"></b></a>
        <ul class="dropdown-menu" data-role="dragon-type-dropdown">
          <li><a href="#">Loading...</a></li>
        </ul>
      </li>
      <!-- Search Box -->
      <li>
        <div class="navbar-form">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search" data-role="search-dragon">
          </div>
        </div>
      </li>
      <!-- Reload Nutton -->
      <li>
        <div class="navbar-form">
          <button type="submit" class="btn btn-default" data-role="reload">Reload</button>
        </div>
      </li>
      <!-- Tools -->
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-cog"></i>Tools <b class="caret"></b></a>
        <ul class="dropdown-menu">
          <li><a href="#" data-role="setmydragon"><i class="glyphicon glyphicon-star"></i>My Dragons</a></li>
          <li class="divider"></li>
          <li><a href="https://itunes.apple.com/app/dragon-story/id513474544" target="_blank"><i class="glyphicon glyphicon-cloud-download"></i>iOS App</a></li>
          <li><a href="https://play.google.com/store/apps/details?id=com.teamlava.dragon" target="_blank"><i class="glyphicon glyphicon-cloud-download"></i>Android App</a></li>
          <li class="divider"></li>
          <li><a href="http://forums.storm8.com/forumdisplay.php?209-Dragon-Story" target="_blank"><i class="glyphicon glyphicon-comment"></i>Forum</a></li>
          <li><a href="http://dragon-story.wikia.com/" target="_blank"><i class="glyphicon glyphicon-link"></i>Wikia</a></li>
        </ul>
      </li>
    </ul>
  </div>
</nav>

<div id="new-dragon-notice" class="jumbotron flyover flyover-centered">
   <h2>New Dragon !!!</h2>
   <p></p>
   <button class="btn btn-primary" data-role="close">Dismiss</button>
</div>

<div class="container">
  <ul class="nav nav-tabs" id="tabs">
    <li class="active"><a href="#breedtab" data-toggle="tab">Breeding</a></li>
    <li><a href="#parenttab" data-toggle="tab">Parents</a></li>
    <li><a href="#battletab" data-toggle="tab">Battle Arena</a></li>
    <li><a href="#mydragontab" data-toggle="tab">My Dragons</a></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane active" id="breedtab">
      <iframe src="breed.html"></iframe>
    </div>
    <div class="tab-pane" id="parenttab">
      <iframe src="parent.html"></iframe>
    </div>
    <div class="tab-pane" id="battletab">
      <iframe id="battlelib" src="battle-lib.html" data-role="libiframe"></iframe>
      <div class="form-group">
      </div>
      <div class="form-group">
        Opponent Dragon
      </div>
      <div class="form-group">
        <div class="btn-group btn-group-s" data-toggle="buttons" id="battle-prefix-list" data-role="dragon-prefix-btn-group" data-radio-name="battleprefix" data-for="#battle-list"></div>
      </div>
      <div class="form-group">
        <span style="margin-left: 100px;">Select a dragon first</span>
        <div class="btn-group btn-group-s" data-toggle="buttons" data-role="dragon-name-btn-group" data-radio-name="dragonname" id="battle-list"></div>
      </div>
      <div class="form-group">
        <div class="row">
          <div class="col-sm-1 col-md-1">
            <span class="label label-default">Level</span>
          </div>
          <div class="col-sm-11 col-md-11">
            <div class="btn-group btn-group-s" data-toggle="buttons" data-role="dragon-level-btn-group" data-radio-name="dragonlevel" id="battle-level"></div>
          </div>
        </div>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <div id="battle-result"></div>
      </div>
    </div>
    <div class="tab-pane" id="mydragontab">
      <div class="form-group"></div>
      <div class="form-group">
        <div class="btn-group btn-group-s" data-toggle="buttons" id="mydragon-prefix-list" data-role="dragon-prefix-btn-group" data-radio-name="mydragonprefix" data-hasall="true"></div>
      </div>
      <div class="form-group" data-role="dragon-count-text"></div>
      <div id="mydragoncontainer"></div>
    </div>
  </div>

  <div class="well">
    <div class="row">
      <div class="col-sm-6 col-md-6">
        Twitter <a href="http://twitter.com/angusdev">@angusdev</a>
      </div>
      <div class="col-sm-6 col-md-6" style="text-align:right;">
        Data Source: <a href="http://dragon-story.wikia.com/">http://dragon-story.wikia.com/</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="input-mydragon">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">My Dragon Setting</h4>
      </div>
      <div class="modal-body">
        <h5>Current Settings <span data-role="oldsettingcount"></span></h5>
        <textarea data-role="oldsetting" rows="4" readonly="true"></textarea>
        <h5>New Settings <span data-role="newsettingcount"></span></h5>
        <textarea data-role="newsetting" rows="4"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-role="save">Save changes</button>
      </div>
    </div>
  </div>
</div> <!-- #input-mydragon -->
</body>
<script>
var ds = org.ellab.dragonstory;

function loadData(reload) {
  $('#dragon-count').html('Loading...');

  $('.tab-content iframe').each(function(){
    this.contentWindow.$('body').trigger('ellabBreedDataBeforeLoad');
    this.contentWindow.$('body').trigger('ellabBattleDataBeforeLoad');
  });

  if (reload) {
    ds.clearStoredBreedData();
    ds.clearStoredBattleData();
  }

  $.when(ds.loadBreedData(), ds.loadBattleData()).done(function(breed, battle) {
    var oldbreeds = (typeof breeds !== 'undefined')?breeds:null;
    var addedDragonHTML = '';

    // I know, I know this is dangerous
    eval(breed);

    $('[data-role="dragon-type-dropdown"]').empty();

    var typeCount = {};
    var typeArray = [];
    var typeaheadArray = [];

    for (type in type_image_url) {
      typeArray.push(type);
      typeCount[type] = { count: 0, dragons: [] };
    }
    typeArray.sort();

    if (breeds && type_image_url) {
      for (dragonid in breeds) {
        var dragon = breeds[dragonid];

        // build the type count
        (breeds[dragonid].types || []).forEach(function(type) {
          typeCount[type].count++;
          typeCount[type].dragons.push({dragonid: dragonid, dragon: breeds[dragonid]});
        });

        // compare the added dragons
        if (oldbreeds && typeof oldbreeds[dragonid] === 'undefined') {
          addedDragonHTML += '<div class="row"><div class="col-md-4 col-sm-4">' + ds.capitalize(dragonid) + '</div><div class="col-md-8 col-sm-8">';
          (breeds[dragonid].types || []).forEach(function(type) {
            addedDragonHTML += '<img src="' + type_image_url[type] + '"/> ';
          });
          addedDragonHTML += '</div></div>';
        }

        // build the typeahead array
        var typeaheadTypeHTML = '';
        (dragon.types || []).forEach(function(typeaheadType) {
          typeaheadTypeHTML += ' <img width="16" src="' + type_image_url[typeaheadType] + '"/> ';
        });

        typeaheadArray.push({
          dragonid: dragonid,
          dragon: dragon,
          name: breeds[dragonid].name,
          rarity: ds.getRarityDesc([breeds[dragonid].rarity]),
          types: typeaheadTypeHTML,
          tokens: [ dragonid ]
        });
      }

      // build the dragon dropdown menu
      typeArray.forEach(function(type) {
        var dropdownHTML = '<li class="dropdown-submenu"><a href="#"><img src="' + type_image_url[type] + '" width="16" /> '  +
          ds.capitalize(type) +
          ' (' + typeCount[type].count + ')</a><ul class="dropdown-menu">';

        typeCount[type].dragons.forEach(function(dragon) {
          dropdownHTML += '<li><a href="#" data-dragonid="' + dragon.dragonid + '" class="dragon-name">' +
                          dragon.dragon.name +
                          ' <img width="16" src="' + type_image_url[type] + '"/> ';
          (dragon.dragon.types || []).forEach(function(othertype) {
            if (type !== othertype) {
              dropdownHTML += ' <img width="16" src="' + type_image_url[othertype] + '"/> ';
            }
          });
          dropdownHTML += '</a></li>';
        });

        dropdownHTML += '</ul></li>';

        $('[data-role="dragon-type-dropdown"]').append(dropdownHTML);
      });
    }


    $('[data-role="search-dragon"]').typeahead('destroy').typeahead({
      name: 'dragons',
      local: typeaheadArray,
      template: [
        '<div class="row"><div class="col-md-5 col-xs-5 dragon-name">{{name}}</div>' +
        '<div class="col-md-3 col-xs-3">{{{types}}}</div>' +
        '<div class="col-md-4 col-xs-4 dragon-rarity">{{rarity}}</div></div>'
      ].join(''),
      engine: Hogan,
      limit: 10
    });

    $('#dragon-count').html(typeArray.length + ' Types, ' + Object.keys(breeds).length + ' Dragons');
    if (addedDragonHTML) {
      $('#new-dragon-notice').addClass('in').find('> p').html(addedDragonHTML);
    }

    // finish decorating the navbar

    ds.clearDragonBtn();
    ds.clearLevelBtn();

    ds.makeDragonBtn();
    ds.makeLevelBtn();

    ds.buildMyDragon(true, '#mydragoncontainer', '#mydragontab [data-role="dragon-count-text"]');

    // filter mydragon
    $('#mydragon-prefix-list').on('change', ':radio', function() {
      var prefix = $(this).closest('.btn-group').find(':checked').val();
      if (prefix) {
        $('#mydragoncontainer tbody tr').each(function() {
          var $this = $(this);
          var dragonName = $this.data('dragonname');
          if (dragonName && dragonName.length > 0 && (prefix === '*' || dragonName.charAt(0).toUpperCase() === prefix.toUpperCase())) {
            $this.show();
          }
          else {
            $this.hide();
          }
        });
      }
    });

    //breeds = null;
    //type_image_url = null;

    $('.tab-content iframe').each(function(){
      this.contentWindow.$('body')
        .trigger('ellabBreedDataChanged', [ breed ] )
        .trigger('ellabBattleDataChanged', [ battle ] );
    });
  });
}

function onSetMyDragon() {
  if (!localStorage) {
    alert("Oops! Your browser doesn't support LocalStorage");
    return;
  }

  var setting = localStorage.getItem('ellab-dragonstory-mydragon') || '';
  var count = 0;
  try {
    count = Object.keys(JSON.parse(setting)).length;
    $('#input-mydragon [data-role="oldsettingcount"]').html(' (' + count + ' Dragon' + (count>1?'s':'') + ')');
    $('#input-mydragon [data-role="oldsetting"]').val(setting);
  }
  catch (err) {
  }

  $('#input-mydragon').modal('show').find('[data-role="newsetting"]').focus();
}

function onSetMyDragonSave() {
  var newsetting = $('#input-mydragon [data-role="newsetting"]').val();

  if (newsetting) {
    var count = 0;
    try {
      count = Object.keys(JSON.parse(newsetting)).length;
      if (confirm('Your new setting consists of ' + count + ' dragons,\nare you sure to apply?')) {
        $('#input-mydragon').modal('hide');
        localStorage.setItem('ellab-dragonstory-mydragon', newsetting);
        ds.buildMyDragon(false, '#mydragoncontainer', '#mydragontab [data-role="dragon-count-text"]');
        // switch to mydragon tab
        $('a[href="#mydragontab"][data-toggle="tab"]').click();
      }
    }
    catch (err) {
      alert('The setting is not valid, please try again.');
    }
  }
}

function onSetMyDragonChange() {
  var newsetting = $('#input-mydragon [data-role="newsetting"]').val();

  if (newsetting) {
    var count = 0;
    try {
      count = Object.keys(JSON.parse(newsetting)).length;
      $('#input-mydragon [data-role="newsettingcount"]').html(' (' + count + ' Dragon' + (count>1?'s':'') + ')');    }
    catch (err) {
    }
  }
}

var breedReady = false;
var parentReady = false;
var battleReady = false;

$(document).ready(function() {
  if (document.location.protocol === 'file:') {
    $('.tab-content iframe').height(1000);
  }
  else {
    window.setInterval(function() {
      $('.tab-content iframe[data-role!="libiframe"]').each(function() {
        var h = $(this).contents().find(".container").height();
        $(this).height(h);
      });
    }, 100);
  }

  // switch to the tab in hash
  var hash = window.location.hash;
  if (hash) {
    $('.nav-tabs a[href=' + hash + '][data-toggle="tab"]').click();
  }
  // Change hash for page-reload
  $('.nav-tabs').on('click', '[data-toggle="tab"]', function (e) {
    window.location.hash = e.target.hash;
  })

  // nav bar reload data
  $('[data-role="reload"]').click(function(e) {
    loadData(true);
  });

  // set my dragon
  $('[data-role="setmydragon"]').click(function(e) {
    e.stopPropagation();
    onSetMyDragon();
  });

  // save my dragon
  $('#input-mydragon [data-role="save"]').click(function(e) {
    e.stopPropagation();
    onSetMyDragonSave();
  });

  $('#input-mydragon [data-role="newsetting"]').bind('change', function(e) {
    onSetMyDragonChange();
  });

  $(document).on('click', '.jumbotron [data-role="close"]', function() {
    $(this).closest('.jumbotron').removeClass('in');
  });

  $(document).on('click', '[data-role="dragon-type-dropdown"] a[data-dragonid]', function(e) {
    var dragonid = $(e.target).data('dragonid');
    $('.tab-content .tab-pane.active iframe').each(function() {
      this.contentWindow.$('body').trigger('ellab.globalselectdragon', [ dragonid, breeds[dragonid] ]);
    });
  });

  $(document).on('typeahead:selected', '[data-role="search-dragon"]', function(e, datum) {
    $('.tab-content .tab-pane.active iframe').each(function() {
      this.contentWindow.$('body').trigger('ellab.globalselectdragon', [ datum.dragonid, datum.dragon ]);
    });
  });

  // click battle dragon or level
  $(document).on('change', '#battle-list :radio, #battle-level :radio', function() {
    var dragonid = $('#battle-list :checked').val();
    var level = $('#battle-level :checked').val();
    if (dragonid && level) {
      $('#battle-result').empty();
      document.getElementById('battlelib').contentWindow.$('body').trigger('ellab.battle.request', [ dragonid, level ]);
    }
  });

  $(document.body).bind('ellab.battle.response', function(e, html) {
    if (html) {
      $('#battle-result').html(html);
    }
  });

  $(document.body).bind('ellabPageReady', function(e, page) {
    console.log('ellabPageReady ' + page);

    if (page === 'breed') {
      breedReady = true;
    }
    else if (page === 'parent') {
      parentReady = true;
    }
    else if (page === 'battle') {
      battleReady = true;
    }

    if (breedReady && parentReady && battleReady) {
      loadData();
    }
  });

});
</script>
</html>
