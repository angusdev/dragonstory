<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Dragon Story</title>
<link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
<link rel="stylesheet" href="bootstrap-more.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.13.3/css/theme.bootstrap.css">
<style>
.container {
  width: 100%;
}

th {
  text-align: center;
}

/* make it invisible */
iframe[data-role=libiframe] {
  position:absolute;
  left:-1000px;
  width:1px;
  height:1px;
  border: none;
  overflow: hidden;
}

.dragon-name {
  color: rgb(153, 51, 1);
  font-weight: bold;
}

.dragon-rarity {
  color: rgb(100, 100, 100);
  font-weight: bold;
}

/* fine tune the padding to reduce the too-much spaces */
.nav > li > a {
  padding-left: 10px;
  padding-right: 10px;
}

.navbar-form {
  padding-left: 0;
  padding-right: 10px;
}
/* fine tune the padding to reduce the too-much spaces */

.navbar .twitter-typeahead .tt-dropdown-menu {
  width: 360px;
}

.navbar .dragon-name {
  color: rgb(153, 51, 1);
  font-weight: bold;
}

.navbar .tt-is-under-cursor .dragon-name, .navbar .tt-is-under-cursor .dragon-rarity {
  color: white;
}

.navbar .glyphicon {
  margin-right:10px;
}

.navbar .popover {
  max-width: 800px;
}

.navbar .popover hr {
  margin-top: 10px;
  margin-bottom: 10px;
}

.navbar .popover .popover-content > div:first-child {
  margin-top: 5px;
}

#dragon-score-progress {
  width: 120px;
  margin-left: 0;
  cursor: pointer;
}

#mydragon-result .tablesorter th:nth-child(n+5) .tablesorter-header-inner {
  text-align: center;
  padding: 4px;
}

#mydragon-result td:nth-child(n+2) {
  text-align: center;
}

#mydragon-result .tablesorter td:nth-child(n+5) {
  text-align: center;
  color: #aaa;
}

#mydragon-result .tablesorter [data-level="0"].selected {
  background-color: #aaa;
}

#mydragon-result .tablesorter .selected {
  background-color: #cfb;
}

#input-mydragon textarea {
  width: 100%;
}

#breed-result td:first-child, #breed-result td:nth-child(2n+5),
#parent-result td:first-child, #battle-result td:first-child {
  text-align: left;
}

#breed-result td:nth-child(2n+4) {
  text-align: right;
}

#breed-result td, #parent-result td, #battle-result td {
  text-align: center;
}

#dragondb-result td {
  vertical-align: middle;
}

#dragondb-result td:nth-child(n+2) {
  text-align: center;
}

@media(max-width:991px){
  .navbar-gameprogress-label {
    display: none;
  }

 .navbar .twitter-typeahead {
   width: 120px;
 }

 .navbar .twitter-typeahead .tt-dropdown-menu {
   width: 300px;
 }

  #dragon-score-progress {
    width: 70px;
    margin-left: 0;
  }
}
</style>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
  <div class="navbar-header">
    <span class="navbar-brand">Dragon Story</span>
  </div>

  <div class="collapse navbar-collapse navbar-right">
    <!-- Dragon Score -->
    <div class="nav navbar-text navbar-gameprogress-label">
      Game Progress
    </div>
    <div id="dragon-score-progress" class="nav navbar-text progress" data-trigger="click" data-toggle="popover" data-placement="bottom" data-html="true" title="Game Progress">
      <div class="progress-bar progress-bar-success" style="width:0%;"></div>
    </div>
    <ul class="nav navbar-nav">
      <!-- Dragon Dropdown -->
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id='dragon-count'>Loading...</span> <b class="caret"></b></a>
        <ul class="dropdown-menu" data-role="dragon-type-dropdown">
          <li><a href="#">Loading...</a></li>
        </ul>
      </li>
      <!-- Search Box -->
      <li>
        <div class="navbar-form">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search" data-role="search-dragon" autofocus="autofocus" />
          </div>
        </div>
      </li>
      <!-- Reload Nutton -->
      <li>
        <div class="navbar-form">
          <button type="submit" class="btn btn-default" data-role="reload">Reload</button>
        </div>
      </li>
      <!-- Tools -->
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-cog"></i>Tools <b class="caret"></b></a>
        <ul class="dropdown-menu">
          <li><a href="#" data-role="manage-mydragon"><i class="glyphicon glyphicon-star"></i>My Dragons</a></li>
          <li class="divider"></li>
          <li><a href="#" data-toggle="modal" data-target="#clear-storage"><i class="glyphicon glyphicon-trash"></i>Clear Storage</a></li>
          <li class="divider"></li>
          <li><a href="https://itunes.apple.com/app/dragon-story/id513474544" target="_blank"><i class="glyphicon glyphicon-cloud-download"></i>iOS App</a></li>
          <li><a href="https://play.google.com/store/apps/details?id=com.teamlava.dragon" target="_blank"><i class="glyphicon glyphicon-cloud-download"></i>Android App</a></li>
          <li class="divider"></li>
          <li><a href="http://forums.storm8.com/forumdisplay.php?209-Dragon-Story" target="_blank"><i class="glyphicon glyphicon-comment"></i>Forum</a></li>
          <li><a href="http://dragon-story.wikia.com/" target="_blank"><i class="glyphicon glyphicon-link"></i>Wikia</a></li>
        </ul>
      </li>
    </ul>
  </div>
</nav>

<div id="new-dragon-notice" class="jumbotron flyover flyover-centered">
   <h2>New Dragon !!!</h2>
   <p></p>
   <button class="btn btn-primary" data-role="close">Dismiss</button>
</div>

<div class="container">
  <ul class="nav nav-tabs" id="tabs">
    <li class="active"><a href="#breedtab" data-toggle="tab">Breeding</a></li>
    <li><a href="#parenttab" data-toggle="tab">Parents</a></li>
    <li><a href="#battletab" data-toggle="tab">Battle Arena</a></li>
    <li><a href="#mydragontab" data-toggle="tab">My Dragons</a></li>
    <li><a href="#dragondbtab" data-toggle="tab">Dragon Database</a></li>
  </ul>

  <div class="tab-content">
    <!--
       #                               #   #            #
       #                               #   #            #
       # ##   # ##    ###    ###    ## #  ####    ###   # ##
       ##  #  ##  #  #   #  #   #  #  ##   #         #  ##  #
       #   #  #      #####  #####  #   #   #      ####  #   #
       ##  #  #      #      #      #  ##   #  #  #   #  ##  #
       # ##   #       ###    ###    ## #    ##    ####  # ##
    -->
    <div class="tab-pane active" id="breedtab">
      <form class="form-horizontal">
        <div class="form-group"></div>
        <div class="form-group row">
          <div class="col-sm-12 col-lg-1"><p class="form-control-static">Dragon 1</p></div>
          <div class="col-sm-12 col-lg-11 btn-group btn-group-s" data-toggle="buttons" id="breed-prefix-list-1" data-role="dragon-prefix-btn-group" data-radio-name="breedprefix1" data-for="#breed-list-1"></div>
        </div>
        <div class="form-group row">
          <div class="col-sm-12 btn-group btn-group-s" data-toggle="buttons" data-role="dragon-name-btn-group" data-radio-name="breedname1" id="breed-list-1"></div>
        </div>
        <div class="form-group row">
          <div class="col-sm-12 col-lg-1"><p class="form-control-static">Dragon 2</p></div>
          <div class="col-sm-12 col-lg-11 btn-group btn-group-s" data-toggle="buttons" id="breed-prefix-list-2" data-role="dragon-prefix-btn-group" data-radio-name="breedprefix2" data-for="#breed-list-2"></div>
        </div>
        <div class="form-group row">
          <div class="col-sm-12 btn-group btn-group-s" data-toggle="buttons" data-role="dragon-name-btn-group" data-radio-name="breedname2" id="breed-list-2"></div>
        </div>
        <div data-role="result-filter" style="display:none;">
          <div class="form-group row">
            <div class="col-sm-12"><p class="form-control-static">Filter Result:</p></div>
          </div>
          <div class="form-group row">
            <div class="col-sm-2"><p class="form-control-static">Type</p></div>
            <div class="col-sm-10 btn-group btn-group-s" data-toggle="buttons" data-role="dragon-type-btn-group" data-radio-name="breedtype" id="breed-type-list" data-hasall="selected"></div>
          </div>
          <div class="form-group row">
            <div class="col-sm-2"><p class="form-control-static">Incubation Time</p></div>
            <div class="col-sm-10 btn-group btn-group-s" data-toggle="buttons" data-role="dragon-incubation-btn-group" data-radio-name="breedincubation" id="breed-incubation-list" data-hasall="selected" data-min-hour="1"></div>
          </div>
        </div>
      </form>
      <div class="form-group" style="margin-top:10px;">
        <div id="breed-result"></div>
      </div>
    </div>
    <!--
                                           #      #            #
                                           #      #            #
       # ##    ###   # ##    ###   # ##   ####   ####    ###   # ##
       ##  #      #  ##  #  #   #  ##  #   #      #         #  ##  #
       ##  #   ####  #      #####  #   #   #      #      ####  #   #
       # ##   #   #  #      #      #   #   #  #   #  #  #   #  ##  #
       #       ####  #       ###   #   #    ##     ##    ####  # ##
       #
       #
    -->
    <div class="tab-pane" id="parenttab">
      <form class="form-horizontal">
        <div class="form-group"></div>
        <div class="form-group row">
          <div class="col-sm-12 btn-group btn-group-s" data-toggle="buttons" id="parent-prefix-list" data-role="dragon-prefix-btn-group" data-radio-name="parentprefix" data-for="#parent-list" data-on-select-dragon="id"></div>
        </div>
        <div class="form-group row">
          <div class="col-sm-12 btn-group btn-group-s" data-toggle="buttons" data-role="dragon-name-btn-group" data-radio-name="parentname" id="parent-list"></div>
        </div>
        <div class="form-group row" data-role="result-filter" style="display:none;">
          <div class="col-sm-1"><p class="form-control-static">Filter</p></div>
          <div class="col-sm-11 btn-group btn-group-s" data-toggle="buttons" id="parent-filter-owned">
            <label class="btn btn-default"><input type="radio" name="parentfilter" value="*">All combinations</label>
            <label class="btn btn-default active"><input type="radio" name="parentfilter" value="M" checked="true">Owned dragons only</label>
          </div>
        </div>
      </form>
      <div class="form-group" style="margin-top:10px;">
        <div id="parent-result"></div>
      </div>
    </div>
    <!--
       #              #      #      ##            #            #
       #              #      #       #            #            #
       # ##    ###   ####   ####     #     ###   ####    ###   # ##
       ##  #      #   #      #       #    #   #   #         #  ##  #
       #   #   ####   #      #       #    #####   #      ####  #   #
       ##  #  #   #   #  #   #  #    #    #       #  #  #   #  ##  #
       # ##    ####    ##     ##    ###    ###     ##    ####  # ##
    -->
    <div class="tab-pane" id="battletab">
      <form class="form-horizontal">
        <div class="form-group"></div>
        <div class="form-group row">
          <div class="col-sm-12 col-lg-1"><p class="form-control-static">Opponent</p></div>
          <div class="col-sm-12 col-lg-11 btn-group btn-group-s" data-toggle="buttons" id="battle-prefix-list" data-role="dragon-prefix-btn-group" data-radio-name="battleprefix" data-for="#battle-list" data-on-select-dragon="id"></div>
        </div>
        <div class="form-group row">
          <div class="col-sm-12 btn-group btn-group-s" data-toggle="buttons" data-role="dragon-name-btn-group" data-radio-name="battlename" id="battle-list"></div>
        </div>
        <div class="form-group row">
          <div class="col-sm-1"><p class="form-control-static">Level</p></div>
          <div class="col-sm-11 btn-group btn-group-s" data-toggle="buttons" data-role="dragon-level-btn-group" data-radio-name="dragonlevel" id="battle-level"></div>
        </div>
      </form>
      <div class="form-group" style="margin-top:10px;">
        <div id="battle-result"></div>
      </div>
    </div>
    <!--
                         #                                      #            #
                         #                                      #            #
       ## #   #   #   ## #  # ##    ###    ## #   ###   # ##   ####    ###   # ##
       # # #  #   #  #  ##  ##  #      #  #  #   #   #  ##  #   #         #  ##  #
       # # #  #  ##  #   #  #       ####   ##    #   #  #   #   #      ####  #   #
       # # #   ## #  #  ##  #      #   #  #      #   #  #   #   #  #  #   #  ##  #
       #   #      #   ## #  #       ####   ###    ###   #   #    ##    ####  # ##
              #   #                       #   #
               ###                         ###
    -->
    <div class="tab-pane" id="mydragontab">
      <div class="form-group"></div>
      <div class="form-group">
        <div class="btn-group btn-group-s" data-toggle="buttons" id="mydragon-prefix-list" data-role="dragon-prefix-btn-group" data-radio-name="mydragonprefix" data-hasall="selected"></div>
      </div>
      <div class="form-group" data-role="dragon-count-text"></div>
      <div id="mydragon-result"></div>
    </div>
    <!--
           #                                         #  #       #            #
           #                                         #  #       #            #
        ## #  # ##    ###    ## #   ###   # ##    ## #  # ##   ####    ###   # ##
       #  ##  ##  #      #  #  #   #   #  ##  #  #  ##  ##  #   #         #  ##  #
       #   #  #       ####   ##    #   #  #   #  #   #  #   #   #      ####  #   #
       #  ##  #      #   #  #      #   #  #   #  #  ##  ##  #   #  #  #   #  ##  #
        ## #  #       ####   ###    ###   #   #   ## #  # ##     ##    ####  # ##
                            #   #
                             ###
    -->
    <div class="tab-pane" id="dragondbtab">
      <div class="form-group"></div>
      <div class="form-group">
        <div class="btn-group btn-group-s" data-toggle="buttons" id="dragondb-prefix-list" data-role="dragon-prefix-btn-group" data-radio-name="dragondbprefix" data-hasall="true"></div>
      <div class="form-group"></div>
      <div class="form-group">
        <div class="btn-group btn-group-s" data-toggle="buttons" data-role="dragon-type-btn-group" data-radio-name="dragondbtype" id="dragondb-type-list" data-hasall="true"></div>
      </div>
      <div class="form-group"></div>
      <div class="form-group">
        <div class="btn-group btn-group-s" data-toggle="buttons" data-role="dragon-incubation-btn-group" data-radio-name="dragondbincubation" id="dragondb-incubation-list" data-hasall="true" data-min-hour="1"></div>
      </div>
      <div class="form-group" data-role="dragon-count-text"></div>
      <div id="dragondb-result" data-role="result"></div>
    </div>
  </div>

  <div class="well">
    <div class="row">
      <div class="col-sm-6 col-md-6">
        Twitter <a href="http://twitter.com/angusdev">@angusdev</a>
      </div>
      <div class="col-sm-6 col-md-6" style="text-align:right;">
        Data Source: <a href="http://dragon-story.wikia.com/">http://dragon-story.wikia.com/</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="input-mydragon">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Manage My Dragon</h4>
      </div>
      <div class="modal-body">
        <h5>Current Settings <span data-role="oldsettingcount"></span></h5>
        <textarea data-role="oldsetting" rows="4" readonly="true"></textarea>
        <h5>New Settings <span data-role="newsettingcount"></span></h5>
        <textarea data-role="newsetting" rows="4"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-role="save">Save changes</button>
      </div>
    </div>
  </div>
</div> <!-- #input-mydragon -->

<div class="modal fade" id="clear-storage">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Clear Storage</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" role="form">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div> <!-- #clear-storage -->

<!--
<div class="modal" id="loading" data-backdrop="static" data-keyboard="false" data-show="false">
-->
<div class="modal" id="loading">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Dragon Story</h3>
      </div>
      <div class="modal-body" style="padding-top:100px; padding-bottom:100px;text-align:center;font-size:1.2em;">
        <div style="margin-bottom:50px;">
          Loading data, please wait ...
        </div>
        <div class="progress progress-striped">
          <div class="progress-bar progress-bar-success" style="width: 0%;"></div>
        </div>
      </div>
    </div>
  </div>
</div> <!-- #loading -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="jquery.xdomainajax.ellab-1.0.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
<script src="//cdn.jsdelivr.net/typeahead.js/0.9.3/typeahead.min.js"></script>
<script src="//cdn.jsdelivr.net/hogan.js/2.0.0/hogan.common.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.13.3/jquery.tablesorter.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.4.0/moment.min.js"></script>
<script src="dragonstory.js"></script>
</body>
<script>
var ds = org.ellab.dragonstory;

var g_db = new ds.DragonDB();
//var g_mydragon = new ds.MyDragon();
var g_mydragon = null;

function loadData(reload) {
  $('#dragon-count').html('Loading...');

  $('iframe[role="libiframe"]').each(function(){
    this.contentWindow.$('body').trigger('ellab.breed.data.beforeload');
    this.contentWindow.$('body').trigger('ellab.battle.data.beforeload');
  });

  if (reload) {
    ds.StorageManager.removeExternalData();
  }

  $.when(ds.loadBreedData(), ds.loadBattleData(), ds.loadEggData()).done(function(breed, battle, egg) {
    var oldbreeds = (typeof breeds !== 'undefined')?breeds:null;
    var addedDragonHTML = '';

    // I know, I know this is dangerous
    eval(breed);
    // For some reason the breed data doesn't contain the egypt type image
    if (type_image_url && typeof type_image_url['egypt'] === 'undefined') {
      type_image_url['egypt'] = 'http://img4.wikia.nocookie.net/__cb20140312050356/dragon-story/images/e/e8/Egypt30px.png';
    }
    g_db.setEggs(egg);
    g_db.reindex();
    g_mydragon = new ds.MyDragon();
    $('#dragon-score').html(g_mydragon.dragonScoreHTML);

    $('[data-role="dragon-type-dropdown"]').empty();

    var typeCount = {};
    var typeArray = [];
    var typeaheadArray = [];

    for (type in type_image_url) {
      typeArray.push(type);
      typeCount[type] = { count: 0, dragons: [] };
    }
    typeArray.sort();

    if (breeds && type_image_url) {
      for (dragonid in breeds) {
        var dragon = breeds[dragonid];

        // build the type count
        (breeds[dragonid].types || []).forEach(function(type) {
          if (typeCount[type]) {
            typeCount[type].count++;
            typeCount[type].dragons.push({dragonid: dragonid, dragon: breeds[dragonid]});
          }
        });

        // compare the added dragons
        if (oldbreeds && typeof oldbreeds[dragonid] === 'undefined') {
          addedDragonHTML += '<div class="row"><div class="col-md-4 col-sm-4">' + g_db.byID(dragonid).nameWithURL() + '</div><div class="col-md-8 col-sm-8">';
          (breeds[dragonid].types || []).forEach(function(type) {
            addedDragonHTML += '<img src="' + type_image_url[type] + '"/> ';
          });
          addedDragonHTML += '</div></div>';
        }

        // build the typeahead array
        var typeaheadTypeHTML = '';
        (dragon.types || []).forEach(function(typeaheadType) {
          typeaheadTypeHTML += ' <img width="16" src="' + type_image_url[typeaheadType] + '"/> ';
        });

        typeaheadArray.push({
          dragonid: dragonid,
          dragon: dragon,
          name: breeds[dragonid].name,
          rarity: ds.getRarityDesc([breeds[dragonid].rarity]),
          types: typeaheadTypeHTML,
          tokens: [ dragonid ]
        });
      }

      // build the dragon dropdown menu
      typeArray.forEach(function(type) {
        var dropdownHTML = '<li class="dropdown-submenu"><a href="#"><img src="' + type_image_url[type] + '" width="16" /> '  +
          ds.capitalize(type) +
          ' (' + typeCount[type].count + ')</a><ul class="dropdown-menu">';

        typeCount[type].dragons.forEach(function(dragon) {
          dropdownHTML += '<li><a href="#" data-dragonid="' + dragon.dragonid + '" class="dragon-name">' +
                          dragon.dragon.name +
                          ' <img width="16" src="' + type_image_url[type] + '"/> ';
          (dragon.dragon.types || []).forEach(function(othertype) {
            if (type !== othertype) {
              dropdownHTML += ' <img width="16" src="' + type_image_url[othertype] + '"/> ';
            }
          });
          dropdownHTML += '</a></li>';
        });

        dropdownHTML += '</ul></li>';

        $('[data-role="dragon-type-dropdown"]').append(dropdownHTML);
      });
    }

    $('[data-role="search-dragon"]').typeahead('destroy').typeahead({
      name: 'dragons',
      local: typeaheadArray,
      template: [
        '<div class="row"><div class="col-md-5 col-xs-5 dragon-name">{{name}}</div>' +
        '<div class="col-md-3 col-xs-3">{{{types}}}</div>' +
        '<div class="col-md-4 col-xs-4 dragon-rarity">{{rarity}}</div></div>'
      ].join(''),
      engine: Hogan,
      limit: 10
    });

    $('#dragon-count').html(typeArray.length + ' Types, ' + Object.keys(breeds).length + ' Dragons');
    if (addedDragonHTML) {
      $('#new-dragon-notice').addClass('in').find('> p').html(addedDragonHTML);
    }

    // finish decorating the navbar

    ds.clearDragonBtns();
    ds.makeDragonBtns();

    ds.buildMyDragon(true, '#mydragon-result', '#mydragontab [data-role="dragon-count-text"]');
    $('#dragondb-result').empty();

    //breeds = null;
    //type_image_url = null;

    $('iframe[data-role="libiframe"]').each(function(){
      this.contentWindow.$('body')
        .trigger('ellab.breed.data.changed', [ breed ] )
        .trigger('ellab.battle.data.changed', [ battle ] );
    });

    // set the progress to 100% and hide it after a while (let user see the 100% progress)
    if ($('#loading').is(':visible')) {
      $('#loading .progress-bar').css({ width: '100%' }).html('100%');
      window.setTimeout(function() {
        $('#loading').modal('hide');
      }, 500);
    }
  }).progress(function(breedStatus, battleStatus, eggStatus) {
    breedStatus = breedStatus || {};
    battleStatus = battleStatus || {};
    eggStatus = eggStatus || {};

    var completed = (breedStatus.completed?1:0) + (battleStatus.completed?1:0) + (eggStatus.completed?1:0);
    if (breedStatus.beforeAjax || battleStatus.beforeAjax || eggStatus.beforeAjax) {
      if (!$('#loading').is(':visible')) {
        // reset the progress
        $('.progress').removeClass('active');
        $('#loading .progress-bar').css({ width: 0 }).html(0);
        $('.progress').addClass('active');
        $('#loading').modal('show');
      }
      var pct = Math.round(completed / 3 * 100, 0) + '%';
      $('#loading .progress-bar').css({ width: pct }).html(completed > 0?pct:'');
    }
  });
}

function onManageMydragon() {
  if (!localStorage) {
    alert("Oops! Your browser doesn't support LocalStorage");
    return;
  }

  // close other modal
  $('.modal').modal('hide');

  $('#input-mydragon [data-role="oldsettingcount"]').html(g_mydragon.dragonCountHTML?(' (' + g_mydragon.dragonCountHTML + ')'):'');
  $('#input-mydragon [data-role="oldsetting"]').val(g_mydragon.json);

  $('#input-mydragon').modal('show').find('[data-role="newsetting"]').focus();
}

function onManageMydragonSave() {
  var newsetting = $('#input-mydragon [data-role="newsetting"]').val();

  if (newsetting) {
    try {
      // create a tmp obj to count
      var tmpmydragon = new ds.MyDragon(newsetting);
      if (confirm('Your new setting consists of ' + tmpmydragon.dragonCount + ' dragons,\nare you sure to apply?')) {
        $('#input-mydragon').modal('hide');
        g_mydragon.set(newsetting);
        $('#input-mydragon [data-role="newsetting"]').val('');
        ds.buildMyDragon(false, '#mydragon-result', '#mydragontab [data-role="dragon-count-text"]');
        // switch to mydragon tab
        $('a[href="#mydragontab"][data-toggle="tab"]').click();
      }
    }
    catch (err) {
      alert('The setting is not valid, please try again.');
    }
  }
}

function onManageMydragonChange() {
  var newsetting = $('#input-mydragon [data-role="newsetting"]').val();

  if (newsetting) {
    var count = 0;
    try {
      count = Object.keys(JSON.parse(newsetting)).length;
      $('#input-mydragon [data-role="newsettingcount"]').html(' (' + count + ' Dragon' + (count>1?'s':'') + ')');    }
    catch (err) {
    }
  }
}

function onClearStorage() {
  function formatSize(n) {
    return n===0?'':(n<=1024?"1 KB":Math.round(n / 1024, 0) + " KB");
  }

  var needCreateForm = $('#clear-storage form .form-group').length === 0;

  if (!localStorage) {
    return;
  }

  var info = ds.StorageManager.getStorageInfo();

  for (var key in info) {
    if (needCreateForm) {
      $('#clear-storage form').append((key === 'total' || key === 'all'?'<hr/>':'') + '\
        <div class="form-group"> \
          <div class="col-sm-' + (key==='all'?'6':'3') + '"><p class="form-control-static">' + info[key].name + '</p></div>' +
          (key==='all'?'':'<div class="col-sm-3"><p class="form-control-static" id="clear-storage-' + key + '-updatetime"></p></div>') + ' \
          <div class="col-sm-2"><p class="form-control-static" id="clear-storage-' + key + '-size"></p></div> \
          <div class="col-sm-4"> \
            <button class="btn btn-default" data-role="clear" data-storage-key="' + key + '">Clear</button>' +
            (key === 'mydragon'?' <button class="btn btn-default" data-role="manage-mydragon">Manage</button>':'') + ' \
          </div> \
        </div>'
      );
    }

    if (info[key].size > 0) {
      $('#clear-storage-' + key + '-size').html(formatSize(info[key].size));
      $('#clear-storage-' + key + '-updatetime').html(info[key].updateTime?moment(info[key].updateTime).fromNow():'');
    }
    else {
      $('button[data-storage-key="' + key + '"]').addClass('disabled');
      $('#clear-storage-' + key + '-size').html('');
      $('#clear-storage-' + key + '-updatetime').html('');
    }
  }
}

function onClearStorageClear(target) {
  var key = $(target).data('storage-key');

  if (!confirm('Are you sure to delete the data?')) {
    return;
  }

  if (key === 'mydragon' && !confirm('Are you really sure to delete My Dragon data?\n\nAll your dragon settings will be erased.\n\nConsider to click "Manage" to manage your settings.')) {
    return;
  }

  if (key === 'all') {
    if (!confirm('Are you really sure to delete ALL data from the site, including data not managed by this page?')) {
      return;
    }
    ds.StorageManager.removeAll();
    $(target).closest('.modal').modal('hide');
  }
  if (key === 'total') {
    if (!confirm('Are you really sure to delete ALL data including your My Dragon data?\n\nAll your dragon settings will be erased.\n\nConsider to click "Manage" to manage your settings.')) {
      return;
    }
    ds.StorageManager.removeTotal();
    $(target).closest('.modal').modal('hide');
  }
  else {
    ds.StorageManager.removeItem(key);
    // refresh the content
    onClearStorage();
  }
}

var libBreedReady = false;
var libBattleReady = false;

$(document).ready(function() {
  $('#loading').modal({ backdrop:'static', keyboard:false }).modal('hide');

  $('[data-toggle="popover"]').popover();

  // nav bar reload data
  $('[data-role="reload"]').click(function(e) {
    loadData(true);
  });

  // Manage Mydragon
  $(document).on('click', '[data-role="manage-mydragon"]', function(e) {
    e.stopPropagation();
    onManageMydragon();
  });

  // save my dragon
  $('#input-mydragon [data-role="save"]').click(function(e) {
    e.stopPropagation();
    onManageMydragonSave();
  });


  $('#input-mydragon [data-role="newsetting"]').bind('change', function(e) {
    onManageMydragonChange();
  });

  // clear storage
  $('[data-target="#clear-storage"]').click(function(e) {
    onClearStorage();
  });

  $(document).on('click', '#clear-storage [data-role="clear"]', function(e) {
    e.stopPropagation();
    e.preventDefault();
    onClearStorageClear(e.target);
  });

  $(document).on('click', '.jumbotron [data-role="close"]', function() {
    $(this).closest('.jumbotron').removeClass('in');
  });

  $(document).on('click', '[data-role="dragon-type-dropdown"] a[data-dragonid]', function(e) {
    var dragonid = $(e.target).data('dragonid');
    if (dragonid) {
      $(document).trigger('ellab.selectdragon', [ dragonid ]);
    }
  });

  /*
      ###           ##                   #            ####
     #   #           #                   #             #  #
     #       ###     #     ###    ###   ####           #  #  # ##    ###    ## #   ###   # ##
      ###   #   #    #    #   #  #   #   #             #  #  ##  #      #  #  #   #   #  ##  #
         #  #####    #    #####  #       #             #  #  #       ####   ##    #   #  #   #
     #   #  #        #    #      #   #   #  #          #  #  #      #   #  #      #   #  #   #
      ###    ###    ###    ###    ###     ##          ####   #       ####   ###    ###   #   #
                                                                           #   #
                                                                            ###
  */
  $(document).on('typeahead:selected', '[data-role="search-dragon"]', function(e, datum) {
    $(document).trigger('ellab.selectdragon', [ datum.dragonid ]);
  });

  $(document).bind('ellab.selectdragon', function(e, dragonid) {
    $('.tab-content .tab-pane.active [data-on-select-dragon]').each(function() {
      if (this.getAttribute('data-on-select-dragon') === 'id') {
        ds.selectDragon(this, dragonid);
      }
      else if (this.getAttribute('data-on-select-dragon') === 'prefix') {
        ds.selectPrefix(this, dragonid);
      }
    });
  });

  /*
     ####                            #         #####         #             #####                        #
      #  #                           #           #           #             #                            #
      #  #  # ##    ###    ###    ## #           #     ###   # ##          #      #   #   ###   # ##   ####
      ###   ##  #  #   #  #   #  #  ##           #        #  ##  #         ####   #   #  #   #  ##  #   #
      #  #  #      #####  #####  #   #           #     ####  #   #         #       # #   #####  #   #   #
      #  #  #      #      #      #  ##           #    #   #  ##  #         #       # #   #      #   #   #  #
     ####   #       ###    ###    ## #           #     ####  # ##          #####    #     ###   #   #    ##
  */
  // Breed Tab Event
  (function(){
    // Change on dragon
    $(document).on('change', '#breed-list-1 :radio, #breed-list-2 :radio', function(e) {
      $(this).prop('checked', true);  // fix the bug in bootstrap that click checked radio will uncheck but fire change event

      var dragonid1 = $('#breed-list-1 :checked').val();
      var dragonid2 = $('#breed-list-2 :checked').val();

      if (dragonid1 && dragonid2) {
        $('#breed-result').empty();
        document.getElementById('breedlib').contentWindow.$('body').trigger('ellab.breed.request', [ dragonid1, dragonid2 ]);    }
    });

    // handle switching between list-1 and list-2 on selectdragon event
    var onBreedSelectDragonPrefix = 1;

    $(document).on('click', '#breed-list-1 label', function() {
      onBreedSelectDragonPrefix = 2;
    });

    $(document).on('click', '#breed-list-2 label', function() {
      onBreedSelectDragonPrefix = 1;
    });

    $(document).bind('ellab.selectdragon', function(e, dragonid) {
      ds.selectDragon('#breed-prefix-list-' + onBreedSelectDragonPrefix, dragonid);
    });

    // change on result filter
    $('#breed-type-list').on('change', ':radio', function() {
      var type = $('#breed-type-list :checked').val();

      if (type) {
        ds.resetRadio('#breed-incubation-list');

        var typeimg = type_image_url[type];
        if (typeimg) {
          $('#breed-result tbody tr').each(function() {
            if (this.innerHTML.indexOf(typeimg) !== -1) {
              $(this).show();
            }
            else {
              $(this).hide();
            }
          });
        }
      }
    });

    $('#breed-incubation-list').on('change', ':radio', function() {
      var incubation = ds.getIncubationBtnSelectedRange('#breed-incubation-list');

      if (incubation) {
        ds.resetRadio('#breed-type-list');

        $('#breed-result tbody tr').each(function() {
          var dragonIncubation = parseInt(this.cells[3].textContent, 10) * (this.cells[4].textContent.replace(/\s*/g, '') === 'seconds'?1:3600);
          if (isNaN(dragonIncubation)) {
            return;
          }

          var incubationMatch = dragonIncubation && dragonIncubation > 0 && (incubation === '*' || (dragonIncubation >= incubation.from && dragonIncubation < incubation.to));

          if (incubationMatch) {
            $(this).show();
          }
          else {
            $(this).hide();
          }
        });
      }
    });

    // The breed response handler
    $(document.body).bind('ellab.breed.response', ds.onBreedResponse);
  })();
  // Breed Tab Event

  /*
     ####                                #            #####         #             #####                        #
     #   #                               #              #           #             #                            #
     #   #   ###   # ##    ###   # ##   ####            #     ###   # ##          #      #   #   ###   # ##   ####
     ####       #  ##  #  #   #  ##  #   #              #        #  ##  #         ####   #   #  #   #  ##  #   #
     #       ####  #      #####  #   #   #              #     ####  #   #         #       # #   #####  #   #   #
     #      #   #  #      #      #   #   #  #           #    #   #  ##  #         #       # #   #      #   #   #  #
     #       ####  #       ###   #   #    ##            #     ####  # ##          #####    #     ###   #   #    ##
  */
  $(document).on('change', '#parent-list :radio', function() {
    var dragonid = $('#parent-list :checked').val();
    if (dragonid) {
      $('#parent-result').empty();
      document.getElementById('breedlib').contentWindow.$('body').trigger('ellab.parent.request', [ dragonid ]);
    }
  });

  $(document.body).bind('ellab.parent.response', ds.onParentResponse);

  $('#parent-filter-owned :radio').change(function() {
    var val = $('#parent-filter-owned :radio:checked').val();
    if (val === '*') {
      $('#parent-result [data-not-owned-dragon]').show();
    }
    else if (val === 'M') {
      $('#parent-result [data-not-owned-dragon]').hide();
    }
  });

  $('#parent-result').on('click', '[data-role="do-breed"]', ds.onParentBreedBtn);

  /*
     ####           #      #      ##                  #####         #             #####                        #
      #  #          #      #       #                    #           #             #                            #
      #  #   ###   ####   ####     #     ###            #     ###   # ##          #      #   #   ###   # ##   ####
      ###       #   #      #       #    #   #           #        #  ##  #         ####   #   #  #   #  ##  #   #
      #  #   ####   #      #       #    #####           #     ####  #   #         #       # #   #####  #   #   #
      #  #  #   #   #  #   #  #    #    #               #    #   #  ##  #         #       # #   #      #   #   #  #
     ####    ####    ##     ##    ###    ###            #     ####  # ##          #####    #     ###   #   #    ##
  */
  $(document).on('change', '#battle-list :radio, #battle-level :radio', function() {
    var dragonid = $('#battle-list :checked').val();
    var level = $('#battle-level :checked').val();
    if (dragonid && level) {
      $('#battle-result').empty();
      document.getElementById('battlelib').contentWindow.$('body').trigger('ellab.battle.request', [ dragonid, level ]);
    }
  });

  $(document.body).bind('ellab.battle.response', ds.onBattleResponse);

  /*
    #   #         ####                                             #####                        #
    #   #          #  #                                            #                            #
    ## ##  #   #   #  #  # ##    ###    ## #   ###   # ##          #      #   #   ###   # ##   ####
    # # #  #   #   #  #  ##  #      #  #  #   #   #  ##  #         ####   #   #  #   #  ##  #   #
    #   #  #  ##   #  #  #       ####   ##    #   #  #   #         #       # #   #####  #   #   #
    #   #   ## #   #  #  #      #   #  #      #   #  #   #         #       # #   #      #   #   #  #
    #   #      #  ####   #       ####   ###    ###   #   #         #####    #     ###   #   #    ##
           #   #                       #   #
            ###                         ###
  */
  $('#mydragon-prefix-list').on('change', ':radio', ds.onMyDragonPrefixChange);

  $(document).bind('ellab.selectdragon', ds.onMyDragonSelectDragon);

  /*
     ####                                      ####   ####          #####                        #
      #  #                                      #  #   #  #         #                            #
      #  #  # ##    ###    ## #   ###   # ##    #  #   #  #         #      #   #   ###   # ##   ####
      #  #  ##  #      #  #  #   #   #  ##  #   #  #   ###          ####   #   #  #   #  ##  #   #
      #  #  #       ####   ##    #   #  #   #   #  #   #  #         #       # #   #####  #   #   #
      #  #  #      #   #  #      #   #  #   #   #  #   #  #         #       # #   #      #   #   #  #
     ####   #       ####   ###    ###   #   #  ####   ####          #####    #     ###   #   #    ##
                          #   #
                           ###
  */
  $('#dragondb-prefix-list, #dragondb-type-list, #dragondb-incubation-list').on('change', ':radio', function() {
    $(this).prop('checked', true);  // fix the bug in bootstrap that click checked radio will uncheck but fire change event

    if ($('#dragondb-result tbody tr').length === 0) {
      console.log('buildDragonDB');
      ds.buildDragonDB('#dragondb-result');
    }

    ds.onDragonDBChange(this);
  });

  $(document).bind('ellab.selectdragon', function(e, dragonid) {
    $('.tab-content .tab-pane.active #dragondb-result tbody tr[data-dragonid=' + dragonid + ']').show();
    $('.tab-content .tab-pane.active #dragondb-result tbody tr[data-dragonid!=' + dragonid + ']').hide();
  });

  /*
     ####                        ####                     #                #####                        #
     #   #                       #   #                    #                #                            #
     #   #   ###    ## #   ###   #   #   ###    ###    ## #  #   #         #      #   #   ###   # ##   ####
     ####       #  #  #   #   #  ####   #   #      #  #  ##  #   #         ####   #   #  #   #  ##  #   #
     #       ####   ##    #####  # #    #####   ####  #   #  #  ##         #       # #   #####  #   #   #
     #      #   #  #      #      #  #   #      #   #  #  ##   ## #         #       # #   #      #   #   #  #
     #       ####   ###    ###   #   #   ###    ####   ## #      #         #####    #     ###   #   #    ##
                   #   #                                     #   #
                    ###                                       ###
  */
  $(document.body).bind('ellab.lib.ready', function(e, page) {
    console.log('ellab.lib.ready ' + page);

    if (page === 'breed') {
      libBreedReady = true;
    }
    else if (page === 'battle') {
      libBattleReady = true;
    }

    if (libBreedReady && libBattleReady) {
      loadData();
    }

    // loadData() will eventually call 'click' so lost the focus
    window.setTimeout(function() { $('[autofocus]').first().focus(); }, 0);
  });

  // switch to the tab in hash
  var hash = window.location.hash;
  if (hash) {
    $('.nav-tabs a[href=' + hash + '][data-toggle="tab"]').click();
  }

  // Change hash for page-reload
  $('.nav-tabs').on('click', '[data-toggle="tab"]', function (e) {
    window.location.hash = e.target.hash;
  });

  // Everything ready
  $(document.body).append('<iframe id="breedlib" src="breed-lib.html" data-role="libiframe"></iframe>')
                  .append('<iframe id="battlelib" src="battle-lib.html" data-role="libiframe"></iframe>');
});
</script>
</html>
