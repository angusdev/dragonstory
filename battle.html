<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
<script src="http://dragon-story.wikia.com/index.php?title=MediaWiki:BattleArenaSelection.js&amp;action=raw&amp;ctype=text/javascript"></script>
<script src="dragonstory.js"></script>
<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
<style>
.container {
  width: 100%;
}
td.lowerscore {
  background-color: #555 !important;
  color: #aaa !important;
}
</style>
</head>
<body>
<div class="container" style="display:none;">
  <div class="form-group">
  </div>
  <div class="form-group">
    Opponent Dragon
  </div>
  <div class="form-group">
    <div class="btn-group btn-group-s" data-toggle="buttons" id="dragon-prefix-list" data-role="dragon-prefix-btn-group" data-radio-name="dragonprefix" data-for="#dragon-list"></div>
  </div>
  <div class="form-group">
    <span style="margin-left: 100px;">Select a dragon first</span>
    <div class="btn-group btn-group-s" data-toggle="buttons" data-role="dragon-name-btn-group" data-radio-name="dragonname" id="dragon-list"></div>
  </div>
  <div class="form-group">
    <div class="row">
      <div class="col-sm-1 col-md-1">
        <span class="label label-default">Level</span>
      </div>
      <div class="col-sm-11 col-md-11">
        <div class="btn-group btn-group-s" data-toggle="buttons" data-role="dragon-level-btn-group" data-radio-name="dragonlevel" id="dragon-level"></div>
      </div>
    </div>
  </div>
  <div class="form-group" style="margin-top:10px;">
    <div id="result" data-role="result"></div>
  </div>
</div>
<div id='status'>Loading...</div>

<div id="wikia-used-controls" style="display:none;">
  <select id="select_opponent"></select>
  <select id="select_opponent_level"></select>
  <div id="form_opponent"></div>
  <div id="content_scores"></div>
</div>
</body>
<script>
var ds = org.ellab.dragonstory;

$(document).ready(function() {
  $(document.body).bind('ellabBattleDataBeforeLoad', function(e, data) {
    $('#status').show();
    $('.container').hide();
  });

  $(document.body).bind('ellabBattleDataChanged', function(e, data) {
    onBattleDataChanged(data);
  });

  $(document.body).bind('ellab.globalselectdragon', onGlobalSelectDragon);

  window.parent.$('body').trigger('ellabPageReady', [ 'battle' ]);
});

function onBattleDataChanged(data) {
  ds.clearDragonBtn();
  ds.clearLevelBtn();
  $('#result').html('');
  $('#status').hide();
  $('.container').show();

  $('#wikia-used-controls select, #wikia-used-controls div').empty();

  // I know, I know this is dangerous
  eval(data);

  populateDataLists();
  setMenuOptions();
  ds.makeDragonBtn();
  ds.makeLevelBtn();

  // click the dragon or level
  $(document).on('change', '#dragon-list :radio, #dragon-level :radio', function() {
    var dragonid = $('#dragon-list :checked').val();
    var level = $('#dragon-level :checked').val();
    if (dragonid && level) {
      // fill in the hidden element used by the function
      $('#select_opponent option').filter(function() { return this.textContent === breeds[dragonid].name }).prop('selected', true);
      $('#select_opponent_level option').filter(function() { return this.textContent === level }).prop('selected', true);
      calculateScores();

      // show the hidden result, remove all inline style
      $('#result')
        .html($('#content_scores').html())
        .find('table')
          .attr('style', '')
          .addClass("table table-striped table-condensed table-bordered")
          .find('th')
            .attr('style', 'text-align:center;');
    }
  });

  $('#result').on('click', 'td', function() {
    var savedThis = this;
    var $savedThis = $(savedThis);
    if ($savedThis.hasClass('success')) {
      $('#result td').removeClass('lowerscore');
      $('#result tr').show();

      $savedThis.removeClass('success');
    }
    else {
      var rate = parseInt($savedThis.text(), 10);
      $('#result td').each(function() {
        var $this = $(this).removeClass('success');

        var tdrate = parseInt($this.text(), 10);
        if (tdrate < rate) {
          $this.addClass('lowerscore');
        }
        else {
          $this.removeClass('lowerscore');
        }
      });

      // hide the row that all are 'lowerscore'
      $('#result tr').filter(function() {
        return $(this).find('td:not(.lowerscore)').length === 1;
      }).hide();
      $('#result tr').filter(function() {
        return $(this).find('td:not(.lowerscore)').length > 1;
      }).show();

      $savedThis.addClass('success');
    }
  });
}

function onGlobalSelectDragon(e, dragonid, dragon) {
  ds.selectDragon('#dragon-prefix-list', dragonid, dragon.name);
}

</script>
</html>
